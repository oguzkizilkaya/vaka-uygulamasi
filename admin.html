<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli - Medicom AI</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        h2, h3 { color: #1a2a6c; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        .login-box { 
            max-width: 400px; 
            margin: 100px auto; 
            background: white; 
            padding: 40px; 
            border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }

        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px;}
        
        button { 
            padding: 12px 20px; 
            background: #1a2a6c; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background 0.3s;
            width: 100%;
        }
        button:hover { background: #2c3e50; }

        /* Veri Tablosu Stilleri */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            background: white; 
            /* display: none; KALDIRILDI - ArtÄ±k varsayÄ±lan olarak tablo yapÄ±sÄ±nda */
        }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 14px; }
        th { background-color: #1a2a6c; color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e9ecef; }

        .error { color: #dc3545; font-size: 14px; text-align: center; display: block; margin-top: 10px; }
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .btn-logout { background: #dc3545; width: auto; }
        .btn-logout:hover { background: #c82333; }
        
        .btn-csv { background: #28a745; width: auto; display: inline-block; }
        .btn-csv:hover { background: #218838; }

    </style>
</head>
<body>

    <div class="login-box" id="loginScreen">
        <h3 style="text-align:center;">Admin GiriÅŸi</h3>
        <input type="email" id="email" placeholder="E-posta Adresi">
        <input type="password" id="password" placeholder="Åifre">
        <button onclick="adminLogin()">GiriÅŸ Yap</button>
        <span class="error" id="errorMsg"></span>
    </div>

    <div class="container" id="dataScreen" style="display:none;">
        <div class="header-actions">
            <h2>ğŸ“Š Vaka KayÄ±tlarÄ±</h2>
            <button class="btn-logout" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
        
        <button class="btn-csv" onclick="downloadCSV()">ğŸ“¥ CSV (Excel) Ä°ndir</button>
        
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>KullanÄ±cÄ± ID</th>
                    <th>Ä°zlenen Yol</th>
                    <th>SonuÃ§</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQqQ5yd4o07A8Is2Z5UWGnGXuGOcDCCho",
            authDomain: "medicom-ai.firebaseapp.com",
            projectId: "medicom-ai",
            storageBucket: "medicom-ai.firebasestorage.app",
            messagingSenderId: "330987426994",
            appId: "1:330987426994:web:587bc3e397ec376e5565ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Oturum durumunu dinle
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // GiriÅŸ yapÄ±lmÄ±ÅŸsa Login ekranÄ±nÄ± gizle, Data ekranÄ±nÄ± aÃ§
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dataScreen').style.display = 'block';
                // Verileri hemen Ã§ek
                loadData();
            } else {
                // Ã‡Ä±kÄ±ÅŸ yapÄ±lmÄ±ÅŸsa tam tersi
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('dataScreen').style.display = 'none';
            }
        });

        window.adminLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                document.getElementById('errorMsg').innerText = "Hata: " + error.message;
            }
        }

        window.logout = () => signOut(auth);

        async function loadData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Veriler YÃ¼kleniyor...</td></tr>';
            
            try {
                const q = query(collection(db, "vaka_kayitlari"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">HenÃ¼z veri yok.</td></tr>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('tr-TR') : 'Belirsiz';
                    
                    // Renklendirme
                    let color = 'black';
                    if(data.outcome && (data.outcome.includes('MÃ¼kemmel') || data.outcome.includes('BaÅŸarÄ±lÄ±'))) color = '#28a745';
                    else if(data.outcome && (data.outcome.includes('KBY') || data.outcome.includes('HasarlÄ±'))) color = '#fd7e14';
                    else color = '#dc3545';

                    const row = `<tr>
                        <td>${date}</td>
                        <td>${data.id}</td>
                        <td style="font-size:13px; color:#555;">${data.path.join(' â ')}</td>
                        <td style="font-weight:bold; color:${color};">${data.outcome}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">
                    Yetki HatasÄ± veya BaÄŸlantÄ± Sorunu.<br>
                    (LÃ¼tfen bu kullanÄ±cÄ± ile giriÅŸ yaptÄ±ÄŸÄ±nÄ±zdan emin olun)
                </td></tr>`;
            }
        }

        window.downloadCSV = () => {
            let csv = "Tarih,ID,Yol,Sonuc\n";
            const rows = document.querySelectorAll("#dataTable tbody tr");
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                // "Veri yok" veya "YÃ¼kleniyor" satÄ±rlarÄ±nÄ± atlamak iÃ§in kontrol
                if(cols.length > 1) { 
                    csv += `${cols[0].innerText},${cols[1].innerText},"${cols[2].innerText}","${cols[3].innerText}"\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "vaka_analizi.csv";
            link.click();
        }
    </script>
</body>
</html>
