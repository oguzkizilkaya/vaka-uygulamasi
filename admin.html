<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Y√∂netici Paneli - Medicom AI</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .login-box { max-width: 300px; margin: 50px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;}
        button { width: 100%; padding: 10px; background: #1a2a6c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; display: none; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #1a2a6c; color: white; }
        .error { color: red; font-size: 12px; text-align: center; display: block; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="login-box" id="loginScreen">
        <h3 style="text-align:center;">Admin Giri≈üi</h3>
        <input type="email" id="email" placeholder="E-posta">
        <input type="password" id="password" placeholder="≈ûifre">
        <button onclick="adminLogin()">Giri≈ü Yap</button>
        <span class="error" id="errorMsg"></span>
    </div>

    <div id="dataScreen" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Vaka Kayƒ±tlarƒ±</h2>
            <button onclick="logout()" style="width:auto; background:#dc3545;">√áƒ±kƒ±≈ü Yap</button>
        </div>
        <button onclick="downloadCSV()" style="margin-bottom:10px; background:#28a745; width:auto;">üì• Excel (CSV) ƒ∞ndir</button>
        
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>ID</th>
                    <th>Yol (Kararlar)</th>
                    <th>Sonu√ß</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQqQ5yd4o07A8Is2Z5UWGnGXuGOcDCCho",
            authDomain: "medicom-ai.firebaseapp.com",
            projectId: "medicom-ai",
            storageBucket: "medicom-ai.firebasestorage.app",
            messagingSenderId: "330987426994",
            appId: "1:330987426994:web:587bc3e397ec376e5565ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Oturum durumunu dinle
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dataScreen').style.display = 'block';
                loadData();
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('dataScreen').style.display = 'none';
            }
        });

        window.adminLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                document.getElementById('errorMsg').innerText = "Hata: " + error.message;
            }
        }

        window.logout = () => signOut(auth);

        async function loadData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="4">Y√ºkleniyor...</td></tr>';
            
            try {
                const q = query(collection(db, "vaka_kayitlari"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                tbody.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('tr-TR') : 'Belirsiz';
                    
                    const row = `<tr>
                        <td>${date}</td>
                        <td>${data.id}</td>
                        <td style="font-size:12px;">${data.path.join(' ‚ûù ')}</td>
                        <td style="font-weight:bold;">${data.outcome}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" style="color:red">Yetki Hatasƒ±: Verileri g√∂rmeye izniniz yok.</td></tr>`;
            }
        }

        window.downloadCSV = () => {
            let csv = "Tarih,ID,Yol,Sonuc\n";
            const rows = document.querySelectorAll("#dataTable tbody tr");
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                if(cols.length > 1) { // Loading satƒ±rƒ±nƒ± atla
                    csv += `${cols[0].innerText},${cols[1].innerText},"${cols[2].innerText}","${cols[3].innerText}"\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "vaka_analizi.csv";
            link.click();
        }
    </script>
</body>
</html>