<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°nteraktif Vaka: aHÃœS YÃ¶netimi</title>
    <style>
        /* TasarÄ±m kodlarÄ±n aynen korunmuÅŸtur */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .screen { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .screen.active { display: block; opacity: 1; animation: slideUp 0.6s ease-out; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { color: #b21f1f; margin-bottom: 20px; font-size: 26px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        .case-header {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #1a2a6c;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        .status-stable { background: #28a745; }
        .status-critical { background: #dc3545; }
        .status-chronic { background: #ffc107; color: #333; }

        .lab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .lab-item { font-size: 14px; }
        .lab-val { font-weight: bold; color: #b21f1f; }

        .question { font-size: 19px; font-weight: 600; margin-bottom: 25px; color: #2c3e50; }

        .options { display: flex; flex-direction: column; gap: 15px; }
        
        .option-btn {
            background: white;
            border: 2px solid #e9ecef;
            padding: 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .option-btn:hover { border-color: #1a2a6c; background: #f8f9fa; transform: translateX(5px); }
        .option-btn::before {
            content: '';
            position: absolute;
            left: 0; top: 0; height: 100%; width: 5px;
            background: #1a2a6c;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .option-btn:hover::before { opacity: 1; }

        .outcome-screen { text-align: center; padding: 20px; }
        .outcome-icon { font-size: 60px; margin-bottom: 20px; display: block; }
        .outcome-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; }
        .outcome-desc { font-size: 16px; line-height: 1.6; color: #555; margin-bottom: 30px; }
        
        .outcome-good { color: #28a745; }
        .outcome-moderate { color: #fd7e14; }
        .outcome-bad { color: #dc3545; }

        /* Admin & Controls */
        .admin-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: #343a40; color: white; border: none;
            padding: 12px 25px; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .restart-btn {
            background: #1a2a6c; color: white; border: none;
            padding: 15px 40px; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background 0.3s;
        }
        .restart-btn:hover { background: #2c3e50; }

        /* Admin Panel Overlay */
        .admin-panel {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 1000; overflow-y: auto; padding: 40px;
        }
        .admin-panel.active { display: block; }
        .admin-content {
            background: white; max-width: 1000px; margin: 0 auto;
            padding: 30px; border-radius: 10px;
        }
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd; padding: 12px; text-align: left;
        }
        .data-table th { background: #f8f9fa; }
        
        .path-visual { font-family: monospace; font-size: 12px; color: #666; }
        
        /* YÃ¼kleniyor animasyonu iÃ§in */
        .loading-text { text-align: center; padding: 20px; color: #666; font-style: italic; }

    </style>
</head>
<body>

    <div class="container">
        <div class="screen active" id="scene1">
            <h1>Vaka BaÅŸlangÄ±cÄ±</h1>
            <span class="status-badge status-stable">Klinik Durum: Stabil BaÅŸlangÄ±Ã§</span>
            
            <div class="case-header">
                <h3>32 YaÅŸÄ±nda KadÄ±n Hasta</h3>
                <p>Acil servise 5 gÃ¼ndÃ¼r devam eden halsizlik, bulantÄ± ve idrar miktarÄ±nda azalma ÅŸikayeti ile baÅŸvurdu. Ã–ykÃ¼sÃ¼nde bilinen bir hastalÄ±k yok. 1 hafta Ã¶nce hafif bir ÃœYE benzeri tablo geÃ§irmiÅŸ.</p>
            </div>

            <div class="lab-grid">
                <div class="lab-item">Hb: <span class="lab-val">8.1 g/dL</span></div>
                <div class="lab-item">Plt: <span class="lab-val">32.000/mmÂ³</span></div>
                <div class="lab-item">Kreatinin: <span class="lab-val">2.4 mg/dL</span></div>
                <div class="lab-item">LDH: <span class="lab-val">1250 U/L</span></div>
                <div class="lab-item">Periferik Yayma: <span class="lab-val">Åistositler (+)</span></div>
            </div>

            <p class="question">TMA (Trombotik Mikroanjiyopati) tablosu mevcut. Ä°lk yaklaÅŸÄ±mÄ±nÄ±z ve tetkik isteÄŸiniz ne olur?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(1, 'A')">
                    <strong>A)</strong> Plazmaferez hazÄ±rlÄ±ÄŸÄ± yaparÄ±m, ADAMTS13 ve Kompleman paneli gÃ¶nderirim.
                </button>
                <button class="option-btn" onclick="makeDecision(1, 'B')">
                    <strong>B)</strong> Enfeksiyon kaynaklÄ± olabilir, geniÅŸ spektrumlu antibiyotik ve hidrasyon ile 24 saat izlerim.
                </button>
            </div>
        </div>

        <div class="screen" id="scene2a">
            <h1>TanÄ±sal DeÄŸerlendirme</h1>
            <span class="status-badge status-stable">Durum: Kontrol AltÄ±nda</span>
            
            <div class="case-header">
                <h3>SonuÃ§lar Geldi</h3>
                <p>ADAMTS13 aktivitesi: <strong>%65 (Normal)</strong> (TTP Ekarte).<br>
                STEC (Shiga Toksin): <strong>Negatif</strong>.<br>
                Hasta anÃ¼rik hale gelmeye baÅŸladÄ±. Kreatinin: 3.1 mg/dL'ye yÃ¼kseldi.</p>
            </div>

            <p class="question">ADAMTS13 normal, STEC negatif. TTP ve Tipik HÃœS ekarte edildi. TanÄ±nÄ±z aHÃœS. Tedavi planÄ±nÄ±z?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(2, 'A')">
                    <strong>A)</strong> Hemen Eculizumab (C5 Ä°nhibitÃ¶rÃ¼) tedavisi baÅŸla + Menenjit aÅŸÄ±sÄ± yap.
                </button>
                <button class="option-btn" onclick="makeDecision(2, 'B')">
                    <strong>B)</strong> Plazma deÄŸiÅŸimine (TPE) devam et, Eculizumab pahalÄ± olduÄŸu iÃ§in sona sakla.
                </button>
            </div>
        </div>

        <div class="screen" id="scene2b">
            <h1>Klinik KÃ¶tÃ¼leÅŸme</h1>
            <span class="status-badge status-critical">Durum: Kritik</span>
            
            <div class="case-header">
                <h3>24 Saat Sonra</h3>
                <p>HastanÄ±n idrar Ã§Ä±kÄ±ÅŸÄ± tamamen durdu (AnÃ¼ri). Bilinci bulanÄ±klaÅŸmaya baÅŸladÄ±.<br>
                <strong>Yeni Lab:</strong> Hb: 6.5 g/dL, Plt: 18.000, <strong>Kreatinin: 5.8 mg/dL</strong>.<br>
                Destek tedavisi yanÄ±t vermedi.</p>
            </div>

            <p class="question">Zaman kaybettiniz. BÃ¶brek hasarÄ± ilerledi. Åimdi ne yapacaksÄ±nÄ±z?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(2, 'C')">
                    <strong>A)</strong> Acil Hemodiyaliz + Eculizumab tedavisi baÅŸla.
                </button>
                <button class="option-btn" onclick="makeDecision(2, 'D')">
                    <strong>B)</strong> Sadece Diyaliz ve Plazmaferez ile devam et.
                </button>
            </div>
        </div>

        <div class="screen" id="scene3_dialysis">
            <h1>6 Ay Sonra...</h1>
            <span class="status-badge status-chronic">Durum: Kronik BÃ¶brek YetmezliÄŸi (SDBY)</span>
            
            <div class="case-header">
                <h3>Poliklinik KontrolÃ¼</h3>
                <p>Hasta haftada 3 gÃ¼n hemodiyalize giriyor. Hematolojik tablosu dÃ¼zeldi ancak bÃ¶brekler geri dÃ¶nmedi (ESRD).<br>
                CanlÄ± vericiden (annesinden) bÃ¶brek nakli planlanÄ±yor.</p>
            </div>

            <p class="question">aHÃœS tanÄ±lÄ± hastada bÃ¶brek nakli Ã¶ncesi stratejiniz ne olmalÄ±?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(3, 'A')">
                    <strong>A)</strong> Profilaktik Eculizumab baÅŸla, sonra nakil yap.
                </button>
                <button class="option-btn" onclick="makeDecision(3, 'B')">
                    <strong>B)</strong> Sadece nakil yap, nÃ¼ks ederse ilaÃ§ baÅŸlarÄ±z.
                </button>
            </div>
        </div>

        <div class="screen outcome-screen" id="outcome_perfect">
            <span class="outcome-icon outcome-good">ğŸŒŸ</span>
            <h2 class="outcome-title outcome-good">MÃ¼kemmel Klinik YanÄ±t</h2>
            <p class="outcome-desc">
                Erken tanÄ± ve doÄŸru tedavi (Eculizumab) sayesinde hematolojik deÄŸerler 1 haftada dÃ¼zeldi.<br>
                BÃ¶brek fonksiyonlarÄ± tamamen normale dÃ¶ndÃ¼ (Kreatinin: 0.8 mg/dL).<br>
                Hasta diyalize girmeden taburcu edildi.
            </p>
            <div style="background:#eee; padding:10px; border-radius:5px; margin-bottom:20px;">
                <strong>Ã–ÄŸrenim Hedefi:</strong> TMA'da erken ADAMTS13 ayrÄ±mÄ± ve hÄ±zlÄ± aHÃœS tedavisi organ kurtarÄ±cÄ±dÄ±r.
            </div>
            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

        <div class="screen outcome-screen" id="outcome_ckd">
            <span class="outcome-icon outcome-moderate">âš ï¸</span>
            <h2 class="outcome-title outcome-moderate">KÄ±smi DÃ¼zelme (KBY)</h2>
            <p class="outcome-desc">
                Ä°lk baÅŸtaki gecikme veya plazmaferez Ä±srarÄ± nedeniyle bÃ¶breklerde kalÄ±cÄ± hasar oluÅŸtu.<br>
                Hematolojik remisyon saÄŸlandÄ± ancak hasta Evre 3-4 KBY ile takip ediliyor (Kreatinin: 2.1 mg/dL).<br>
                Diyalizden kurtuldu ama Ã¶mÃ¼r boyu yakÄ±n nefroloji takibi gerekecek.
            </p>
            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

        <div class="screen outcome-screen" id="outcome_transplant_success">
            <span class="outcome-icon outcome-good">âœ…</span>
            <h2 class="outcome-title outcome-good">BaÅŸarÄ±lÄ± Nakil</h2>
            <p class="outcome-desc">
                Hasta diyaliz sÃ¼recinden sonra nakile hazÄ±rlandÄ±.<br>
                <strong>Profilaktik Eculizumab</strong> kullanÄ±mÄ± sayesinde greftte hastalÄ±k nÃ¼ksÃ¼ Ã¶nlendi.<br>
                BÃ¶brek fonksiyonlarÄ± ÅŸu an mÃ¼kemmel Ã§alÄ±ÅŸÄ±yor.
            </p>
            <div style="background:#eee; padding:10px; border-radius:5px; margin-bottom:20px;">
                <strong>Bilgi:</strong> aHÃœS'te profilaksi yapÄ±lmadan yapÄ±lan nakillerde nÃ¼ks riski %50-80'dir.
            </div>
            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

        <div class="screen outcome-screen" id="outcome_transplant_fail">
            <span class="outcome-icon outcome-bad">âŒ</span>
            <h2 class="outcome-title outcome-bad">Greft KaybÄ± ve NÃ¼ks</h2>
            <p class="outcome-desc">
                Nakil Ã¶ncesi profilaksi yapÄ±lmadÄ±ÄŸÄ± iÃ§in cerrahi stres ve iskemi, kompleman sistemini tetikledi.<br>
                Nakilden 1 hafta sonra aHÃœS nÃ¼ks etti ve takÄ±lan bÃ¶brekte trombotik mikroanjiyopati geliÅŸti.<br>
                Greft kaybedildi, hasta tekrar diyalize dÃ¶ndÃ¼.
            </p>
            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

    </div>

    <button class="admin-btn" onclick="toggleAdmin()">ğŸ“Š Vaka Analizi</button>
    
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>KullanÄ±cÄ± Karar Analizi</h2>
                <button onclick="toggleAdmin()" style="background:red; color:white; border:none; padding:5px 15px; cursor:pointer;">X</button>
            </div>
            <p><strong>Veriler Firebase VeritabanÄ±nda (Firestore) TutulmaktadÄ±r.</strong></p>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>KullanÄ±cÄ± ID</th>
                        <th>Ä°zlenen Yol</th>
                        <th>SonuÃ§ (Outcome)</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    </tbody>
            </table>
            <div id="loadingMsg" class="loading-text" style="display:none;">Veriler Firebase'den yÃ¼kleniyor...</div>
            
            <div style="margin-top:20px;">
                <button onclick="exportCSV()" style="background:#28a745; color:white; border:none; padding:10px; cursor:pointer;">CSV Ä°ndir</button>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Firebase KÃ¼tÃ¼phanelerini Import Et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 2. Senin VerdiÄŸin Firebase Config Bilgileri
        const firebaseConfig = {
            apiKey: "AIzaSyDQqQ5yd4o07A8Is2Z5UWGnGXuGOcDCCho",
            authDomain: "medicom-ai.firebaseapp.com",
            projectId: "medicom-ai",
            storageBucket: "medicom-ai.firebasestorage.app",
            messagingSenderId: "330987426994",
            appId: "1:330987426994:web:587bc3e397ec376e5565ab"
        };

        // 3. Firebase'i BaÅŸlat
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- State Management ---
        let currentSession = {
            id: 'user_' + Math.random().toString(36).substr(2, 9),
            startTime: new Date().toISOString(),
            path: [],
            outcome: ''
        };

        // --- Navigation Logic (Decision Tree) ---
        // Global scope'a fonksiyonlarÄ± tanÄ±mlÄ±yoruz ki HTML onclick gÃ¶rebilsin
        window.makeDecision = function(step, choice) {
            // Log choice
            currentSession.path.push(`Step${step}:${choice}`);

            // Hide all screens first
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

            // Branching Logic
            if (step === 1) {
                if (choice === 'A') {
                    // DoÄŸru baÅŸlangÄ±Ã§ -> Erken TanÄ± Yolu
                    document.getElementById('scene2a').classList.add('active');
                } else {
                    // YanlÄ±ÅŸ baÅŸlangÄ±Ã§ -> KÃ¶tÃ¼leÅŸme Yolu
                    document.getElementById('scene2b').classList.add('active');
                }
            }
            else if (step === 2) {
                // Sahne 2A (Erken) KararlarÄ±
                if (document.getElementById('scene2a').style.display !== 'none' || currentSession.path.includes('Step1:A')) {
                    if (choice === 'A') {
                        finishCase('MÃ¼kemmel Ä°yileÅŸme', 'outcome_perfect');
                    } else {
                        document.getElementById('scene3_dialysis').classList.add('active');
                    }
                } 
                // Sahne 2B (GeÃ§) KararlarÄ±
                else {
                    if (choice === 'C') { // Eculizumab (GeÃ§ de olsa)
                        finishCase('KalÄ±cÄ± HasarlÄ± Ä°yileÅŸme (KBY)', 'outcome_ckd');
                    } else { // Sadece Diyaliz/Plazma
                        document.getElementById('scene3_dialysis').classList.add('active');
                    }
                }
            }
            else if (step === 3) {
                if (choice === 'A') {
                    finishCase('BaÅŸarÄ±lÄ± Nakil', 'outcome_transplant_success');
                } else {
                    finishCase('Greft Rejeksiyonu', 'outcome_transplant_fail');
                }
            }
        };

        async function finishCase(outcomeName, screenId) {
            currentSession.outcome = outcomeName;
            currentSession.endTime = new Date().toISOString(); // String olarak tarih
            
            // Show outcome screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            // --- FIREBASE'E KAYIT ---
            try {
                // "vaka_kayitlari" koleksiyonuna yazÄ±yoruz
                await addDoc(collection(db, "vaka_kayitlari"), {
                    ...currentSession,
                    createdAt: Timestamp.now() // SÄ±ralama yapmak iÃ§in Firestore zaman damgasÄ±
                });
                console.log("KayÄ±t Firebase'e gÃ¶nderildi.");
            } catch (error) {
                console.error("Firebase HatasÄ±:", error);
                alert("Veri kaydedilemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
            }
        }

        window.resetCase = function() {
            currentSession = {
                id: 'user_' + Math.random().toString(36).substr(2, 9),
                startTime: new Date().toISOString(),
                path: [],
                outcome: ''
            };
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scene1').classList.add('active');
        };

        // --- Data & Admin Functions ---

        window.toggleAdmin = function() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadAdminData();
        };

        async function loadAdminData() {
            const tbody = document.getElementById('dataTableBody');
            const loadingMsg = document.getElementById('loadingMsg');
            
            tbody.innerHTML = '';
            loadingMsg.style.display = 'block';

            try {
                // Firebase'den verileri Ã§ek (Tarihe gÃ¶re tersten sÄ±rala)
                const q = query(collection(db, "vaka_kayitlari"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                loadingMsg.style.display = 'none';

                querySnapshot.forEach((doc) => {
                    const session = doc.data();
                    const row = document.createElement('tr');
                    
                    // Tarihi formatla
                    let dateStr = "Belirsiz";
                    if(session.createdAt && session.createdAt.toDate) {
                        dateStr = session.createdAt.toDate().toLocaleString('tr-TR');
                    } else if (session.startTime) {
                        dateStr = new Date(session.startTime).toLocaleString('tr-TR');
                    }
                    
                    // Renkli outcome
                    let color = 'black';
                    if(session.outcome.includes('MÃ¼kemmel') || session.outcome.includes('BaÅŸarÄ±lÄ±')) color = 'green';
                    else if(session.outcome.includes('KBY')) color = 'orange';
                    else color = 'red';

                    row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${session.id}</td>
                        <td class="path-visual">${session.path.join(' â ')}</td>
                        <td style="color:${color}; font-weight:bold;">${session.outcome}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                loadingMsg.innerText = "Veri Ã§ekilemedi: " + error.message;
                console.error(error);
            }
        }

        window.exportCSV = async function() {
            // Firebase'den gÃ¼ncel veriyi Ã§ekip CSV yapalÄ±m
            try {
                const q = query(collection(db, "vaka_kayitlari"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) return alert('Veri yok');

                let csv = "ID,Tarih,Yol,Sonuc\n";
                querySnapshot.forEach((doc) => {
                    const h = doc.data();
                    const dateStr = h.startTime || "N/A";
                    // CSV formatÄ±nÄ± bozmamak iÃ§in tÄ±rnak iÃ§ine al
                    const pathStr = `"${h.path.join('->')}"`;
                    csv += `${h.id},${dateStr},${pathStr},"${h.outcome}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ahus_vaka_verileri_firebase.csv';
                a.click();
            } catch (e) {
                console.error(e);
                alert("CSV oluÅŸturulurken hata oluÅŸtu.");
            }
        }
    </script>
</body>
</html>
