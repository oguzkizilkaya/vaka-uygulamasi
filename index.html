<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pediatrik Vaka: aHÃœS YÃ¶netimi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .screen { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .screen.active { display: block; opacity: 1; animation: slideUp 0.6s ease-out; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { color: #b21f1f; margin-bottom: 20px; font-size: 26px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        .case-header {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #1a2a6c;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        .status-stable { background: #28a745; }
        .status-critical { background: #dc3545; }
        .status-chronic { background: #ffc107; color: #333; }

        .lab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .lab-item { font-size: 14px; }
        .lab-val { font-weight: bold; color: #b21f1f; }

        .question { font-size: 19px; font-weight: 600; margin-bottom: 25px; color: #2c3e50; }

        .options { display: flex; flex-direction: column; gap: 15px; }
        
        .option-btn {
            background: white;
            border: 2px solid #e9ecef;
            padding: 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .option-btn:hover { border-color: #1a2a6c; background: #f8f9fa; transform: translateX(5px); }
        .option-btn::before {
            content: '';
            position: absolute;
            left: 0; top: 0; height: 100%; width: 5px;
            background: #1a2a6c;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .option-btn:hover::before { opacity: 1; }

        .outcome-screen { text-align: center; padding: 20px; }
        .outcome-icon { font-size: 60px; margin-bottom: 20px; display: block; }
        .outcome-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; }
        .outcome-desc { font-size: 16px; line-height: 1.6; color: #555; margin-bottom: 30px; }
        
        .outcome-good { color: #28a745; }
        .outcome-moderate { color: #fd7e14; }
        .outcome-bad { color: #dc3545; }

        /* YENÄ°: Referans Kutusu Stili */
        .ref-citation {
            background-color: #f8f9fa;
            border-left: 4px solid #1a2a6c;
            padding: 12px;
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: left;
            font-size: 13px;
            color: #555;
            border-radius: 0 5px 5px 0;
            line-height: 1.4;
        }

        .ref-citation strong {
            color: #b21f1f;
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .ref-citation em {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            color: #888;
            text-align: right;
        }

        /* Admin & Controls */
        .admin-btn {
            position: fixed; bottom: 20px; right: 20px;
            background: #343a40; color: white; border: none;
            padding: 12px 25px; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .restart-btn {
            background: #1a2a6c; color: white; border: none;
            padding: 15px 40px; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background 0.3s;
        }
        .restart-btn:hover { background: #2c3e50; }

        /* Admin Panel Overlay */
        .admin-panel {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 1000; overflow-y: auto; padding: 40px;
        }
        .admin-panel.active { display: block; }
        .admin-content {
            background: white; max-width: 1000px; margin: 0 auto;
            padding: 30px; border-radius: 10px;
        }
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd; padding: 12px; text-align: left;
        }
        .data-table th { background: #f8f9fa; }
        
        .path-visual { font-family: monospace; font-size: 12px; color: #666; }
        
        .loading-text { text-align: center; padding: 20px; color: #666; font-style: italic; }

    </style>
</head>
<body>

    <div class="container">
        <div class="screen active" id="scene1">
            <h1>Vaka Sunumu</h1>
            <span class="status-badge status-stable">Pediatrik Acil BaÅŸvurusu</span>
            
            <div class="case-header">
                <h3>4 YaÅŸÄ±nda Erkek Hasta</h3>
                <p>Annesi tarafÄ±ndan "solukluk, huzursuzluk ve son 24 saattir idrar Ã§Ä±kÄ±ÅŸÄ± olmamasÄ±" ÅŸikayetiyle getirildi. Ã–ykÃ¼de 1 hafta Ã¶nce ateÅŸli Ã¼st solunum yolu enfeksiyonu var. <strong>KanlÄ± ishal Ã¶ykÃ¼sÃ¼ yok.</strong></p>
            </div>

            <div class="lab-grid">
                <div class="lab-item">Hb: <span class="lab-val">7.2 g/dL</span> </div>
                <div class="lab-item">Plt: <span class="lab-val">45.000/mmÂ³</span> </div>
                <div class="lab-item">Kreatinin: <span class="lab-val">1.9 mg/dL</span> (YaÅŸa gÃ¶re ABY)</div>
                <div class="lab-item">LDH: <span class="lab-val">1800 U/L</span> </div>
                <div class="lab-item">Periferik Yayma: <span class="lab-val">Åistosit (+)</span></div>
            </div>

            <p class="question"> Mevcut bulgular ile hastaya ilk yaklaÅŸÄ±mÄ±nÄ±z nasÄ±l olur?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(1, 'A')">
                    <strong>A)</strong> STEC-HÃœS ve aHÃœS ayrÄ±mÄ± iÃ§in tetkik (Gaita kÃ¼ltÃ¼rÃ¼, ADAMTS13) isterim, hidrasyona baÅŸlarÄ±m.
                </button>
                <button class="option-btn" onclick="makeDecision(1, 'B')">
                    <strong>B)</strong> Viral enfeksiyon sonrasÄ± geÃ§ici bir tablodur, destek tedavisi ve antibiyotik ile izlerim.
                </button>
            </div>
        </div>

        <div class="screen" id="scene2a">
            <h1>TanÄ±sal DeÄŸerlendirme</h1>
            <span class="status-badge status-stable">SonuÃ§lar Ã‡Ä±ktÄ±</span>
            
            <div class="case-header">
                <h3>Kritik AyrÄ±m</h3>
                <p>Gaita kÃ¼ltÃ¼rÃ¼: <strong>Negatif</strong> <br>
                ADAMTS13 aktivitesi: <strong>%70 (Normal)</strong> <br>
                Hasta halen anÃ¼rik. Kreatinin 2.4 mg/dL'ye yÃ¼kseldi ve yaÅŸa gÃ¶re hipertansif (130/90 mmHg).</p>
            </div>

            <p class="question"> Bu hasta iÃ§in tedavi planÄ±nÄ±z nasÄ±l olur?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(2, 'A')">
                    <strong>A)</strong> Santral kateterizasyon ile plazma deÄŸiÅŸimi baÅŸlayalÄ±m, yanÄ±t alamazsak ilaÃ§ dÃ¼ÅŸÃ¼nelim.
                </button>
                <button class="option-btn" onclick="makeDecision(2, 'B')">
                    <strong>B)</strong> Eculizumab baÅŸla + Meningokok aÅŸÄ±sÄ± ve profilaksisi yap.
                </button>
            </div>
            <div style="font-size:12px; color:#666; margin-top:10px;">*Not: TPE Ã§ocuklarda teknik zorluklar iÃ§erir ve aHÃœS'te etkinliÄŸi sÄ±nÄ±rlÄ±dÄ±r.</div>
        </div>

        <div class="screen" id="scene2b">
            <h1>Klinik KÃ¶tÃ¼leÅŸme</h1>
            <span class="status-badge status-critical">Durum: Kritik</span>
            
            <div class="case-header">
                <h3>12 Saat Sonra</h3>
                <p>Hasta nÃ¶bet geÃ§irdi (aHÃœS santral tutulumu ?).<br>
                <strong>Yeni Lab:</strong> Hb: 6.0 g/dL, Plt: 20.000, <strong>Kreatinin: 3.5 mg/dL</strong>.<br>
                Destek tedavisi yetersiz kaldÄ±. Ã‡oklu organ yetmezliÄŸi riski var.</p>
            </div>

            <p class="question"> HastanÄ±n kliniÄŸi kÃ¶tÃ¼leÅŸiyor, kararÄ±nÄ±z ne yÃ¶nde olur? </p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(2, 'C')">
                    <strong>A)</strong> Acil Diyaliz + Eculizumab tedavisi
                </button>
                <button class="option-btn" onclick="makeDecision(2, 'D')">
                    <strong>B)</strong> Sadece Diyaliz ve Taze DonmuÅŸ Plazma infÃ¼zyonu.
                </button>
            </div>
        </div>

        <div class="screen" id="scene3_dialysis">
            <h1>1 YÄ±l Sonra...</h1>
            <span class="status-badge status-chronic">Durum: Son DÃ¶nem BÃ¶brek YetmezliÄŸi (SDBY)</span>
            
            <div class="case-header">
                <h3>Poliklinik KontrolÃ¼</h3>
                <p>Hasta periton diyalizi ile takip ediliyor. BÃ¼yÃ¼me-geliÅŸme geriliÄŸi baÅŸladÄ±.<br>
                Annesinden canlÄ± bÃ¶brek nakli planlanÄ±yor.</p>
            </div>

            <p class="question">aHÃœS tanÄ±lÄ± Ã§ocuk hastada nakil (transplantasyon) stratejiniz ne olmalÄ±?</p>

            <div class="options">
                <button class="option-btn" onclick="makeDecision(3, 'A')">
                    <strong>A)</strong> Nakil Ã¶ncesi profilaktik Eculizumab baÅŸla, sonra nakil yap.
                </button>
                <button class="option-btn" onclick="makeDecision(3, 'B')">
                    <strong>B)</strong> Sadece nakil yapÄ±p nÃ¼ks gÃ¶zlenirse Eculizumab tedavisi baÅŸlayalÄ±m.
                </button>
            </div>
        </div>

        <div class="screen outcome-screen" id="outcome_perfect">
            <span class="outcome-icon outcome-good">ğŸŒŸ</span>
            <h2 class="outcome-title outcome-good">Tam Ä°yileÅŸme (Renal Recovery)</h2>
            <p class="outcome-desc">
                HÄ±zlÄ± Eculizumab tedavisi (ilk 24-48 saat) sayesinde bÃ¶brek fonksiyonlarÄ± tamamen normale dÃ¶ndÃ¼<br>
                Diyaliz ihtiyacÄ± kalmadÄ±. Ã‡ocuk normal geliÅŸimine devam ediyor.<br>
                Genetik panelde <em>CFH</em> mutasyonu saptandÄ±.
            </p>
            
            <div class="ref-citation">
                <strong>ğŸ“š KanÄ±t Temelli YaklaÅŸÄ±m:</strong>
                Ã‡ocuklarda aHÃœS tanÄ±sÄ± konulur konulmaz Eculizumab birinci basamak (first-line) tedavi olmalÄ±dÄ±r. Plazma tedavisi teknik zorluklar ve dÃ¼ÅŸÃ¼k etkinlik nedeniyle Ã¶nerilmez.
                <em>â€” Loirat C, et al. Pediatric Nephrology. 2016</em>
            </div>

            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

        <div class="screen outcome-screen" id="outcome_ckd">
            <span class="outcome-icon outcome-moderate">âš ï¸</span>
            <h2 class="outcome-title outcome-moderate">KalÄ±cÄ± BÃ¶brek HasarÄ±</h2>
            <p class="outcome-desc">
                TanÄ±daki gecikme ve yetersiz tedavi (sadece plazma) nedeniyle kortikal nekroz geliÅŸti.<br>
                Hematolojik deÄŸerler dÃ¼zeldi ancak GFR 40 ml/dk civarÄ±nda kaldÄ±. Ä°leride nakil adayÄ±.
            </p>

            <div class="ref-citation">
                <strong>ğŸ“š Kritik UyarÄ±:</strong>
                Ã–zellikle pediyatrik hastalarda STEC dÄ±ÅŸlandÄ±ÄŸÄ± ve ADAMTS13 normal saptandÄ±ÄŸÄ± anda zaman kaybetmeden anti-kompleman tedavisine baÅŸlanmasÄ± bÃ¶brek fonksiyon kazanÄ±mÄ± iÃ§in kritiktir.
                <em>â€” KDIGO 2017 Clinical Practice Guideline Update (TMA focus)</em>
            </div>

            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

        <div class="screen outcome-screen" id="outcome_transplant_success">
            <span class="outcome-icon outcome-good">âœ…</span>
            <h2 class="outcome-title outcome-good">BaÅŸarÄ±lÄ± Pediatrik Nakil</h2>
            <p class="outcome-desc">
                Profilaktik Eculizumab kullanÄ±mÄ± sayesinde greftte fonksiyonlarÄ± korundu.<br>
                Hasta diyaliz baÄŸÄ±msÄ±z takip ediliyor ve bÃ¼yÃ¼me eÄŸrisi normal izleniyor
            </p>

            <div class="ref-citation">
                <strong>ğŸ“š Transplantasyon Verisi:</strong>
                BÃ¶brek nakli Ã¶ncesi genetik riski yÃ¼ksek hastalarda profilaktik Eculizumab kullanÄ±mÄ± greft kaybÄ±nÄ± dramatik ÅŸekilde dÃ¼ÅŸÃ¼rÃ¼rken (%10), profilaksi uygulanmamasÄ± ile nÃ¼ks oranÄ± %80'e varabilmektedir.
                <em>â€” Zuber J, et al. Nature Reviews Nephrology. 2012</em>
            </div>

            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

        <div class="screen outcome-screen" id="outcome_transplant_fail">
            <span class="outcome-icon outcome-bad">âŒ</span>
            <h2 class="outcome-title outcome-bad">Greft KaybÄ± ve NÃ¼ks</h2>
            <p class="outcome-desc">
                Nakil sÄ±rasÄ±nda profilaksi yapÄ±lmadÄ±ÄŸÄ± iÃ§in cerrahi stres kompleman sistemini aktive etti.<br>
                Nakilden sonrasÄ± aHÃœS nÃ¼ksÃ¼ ile greft fonksiyonu kaybedildi.
            </p>

            <div class="ref-citation">
                <strong>ğŸ“š Neden BaÅŸarÄ±sÄ±z Oldu?</strong>
                LiteratÃ¼r, profilaktik Eculizumab kullanÄ±lmayan yÃ¼ksek riskli hastalarda nÃ¼ks ve greft kaybÄ± riskinin %80 civarÄ±nda olduÄŸunu gÃ¶stermektedir.
                <em>â€” Zuber J, et al. Nature Reviews Nephrology. 2012</em>
            </div>

            <button class="restart-btn" onclick="resetCase()">VakayÄ± Tekrar BaÅŸlat</button>
        </div>

    </div>

    <button class="admin-btn" onclick="toggleAdmin()">ğŸ“Š Vaka Analizi</button>
    
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>KullanÄ±cÄ± Karar Analizi</h2>
                <button onclick="toggleAdmin()" style="background:red; color:white; border:none; padding:5px 15px; cursor:pointer;">X</button>
            </div>
            <p><strong>Veriler Firebase VeritabanÄ±nda (Firestore) TutulmaktadÄ±r.</strong></p>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>KullanÄ±cÄ± ID</th>
                        <th>Ä°zlenen Yol</th>
                        <th>SonuÃ§ (Outcome)</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    </tbody>
            </table>
            <div id="loadingMsg" class="loading-text" style="display:none;">Veriler Firebase'den yÃ¼kleniyor...</div>
            
            <div style="margin-top:20px;">
                <button onclick="exportCSV()" style="background:#28a745; color:white; border:none; padding:10px; cursor:pointer;">CSV Ä°ndir</button>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Firebase KÃ¼tÃ¼phanelerini Import Et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 2. Senin VerdiÄŸin Firebase Config Bilgileri
        const firebaseConfig = {
            apiKey: "AIzaSyDQqQ5yd4o07A8Is2Z5UWGnGXuGOcDCCho",
            authDomain: "medicom-ai.firebaseapp.com",
            projectId: "medicom-ai",
            storageBucket: "medicom-ai.firebasestorage.app",
            messagingSenderId: "330987426994",
            appId: "1:330987426994:web:587bc3e397ec376e5565ab"
        };

        // 3. Firebase'i BaÅŸlat
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- State Management ---
        let currentSession = {
            id: 'user_' + Math.random().toString(36).substr(2, 9),
            startTime: new Date().toISOString(),
            path: [],
            outcome: ''
        };

        // --- Navigation Logic (Decision Tree) ---
        // Global scope'a fonksiyonlarÄ± tanÄ±mlÄ±yoruz ki HTML onclick gÃ¶rebilsin
        window.makeDecision = function(step, choice) {
            // Log choice
            currentSession.path.push(`Step${step}:${choice}`);

            // Hide all screens first (DÄ°KKAT: active class'Ä±nÄ± kaldÄ±rmadan Ã¶nce kontrolÃ¼ aÅŸaÄŸÄ±da yapacaÄŸÄ±z)
            // Bu yÃ¼zden Ã¶nce class listesini okuyup, sonra gizleyeceÄŸiz.
            const isScene2aActive = document.getElementById('scene2a').classList.contains('active');

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

            // Branching Logic
            if (step === 1) {
                if (choice === 'A') {
                    // DoÄŸru baÅŸlangÄ±Ã§ -> Erken TanÄ± Yolu
                    document.getElementById('scene2a').classList.add('active');
                } else {
                    // YanlÄ±ÅŸ baÅŸlangÄ±Ã§ -> KÃ¶tÃ¼leÅŸme Yolu
                    document.getElementById('scene2b').classList.add('active');
                }
            }
            else if (step === 2) {
                // Sahne 2A (Erken) KararlarÄ±
                // MantÄ±k DÃ¼zeltmesi: EÄŸer bir Ã¶nceki ekran Scene2a ise veya Step1'de A seÃ§ildiyse:
                if (isScene2aActive || currentSession.path.includes('Step1:A')) {
                    // A: TPE (YanlÄ±ÅŸ/Eksik), B: Eculizumab (DoÄŸru)
                    
                    if (choice === 'B') { 
                        finishCase('MÃ¼kemmel Ä°yileÅŸme (Tam Renal Recovery)', 'outcome_perfect');
                    } else {
                        // TPE seÃ§ildi -> Yetersiz tedavi -> Diyaliz
                        document.getElementById('scene3_dialysis').classList.add('active');
                    }
                } 
                // Sahne 2B (GeÃ§) KararlarÄ±
                else {
                    if (choice === 'C') { // Eculizumab (GeÃ§ de olsa)
                        finishCase('KalÄ±cÄ± HasarlÄ± Ä°yileÅŸme (KBY)', 'outcome_ckd');
                    } else { // Sadece Diyaliz/Plazma (D)
                        document.getElementById('scene3_dialysis').classList.add('active');
                    }
                }
            }
            else if (step === 3) {
                if (choice === 'A') {
                    finishCase('BaÅŸarÄ±lÄ± Nakil', 'outcome_transplant_success');
                } else {
                    finishCase('Greft Rejeksiyonu', 'outcome_transplant_fail');
                }
            }
        };

        async function finishCase(outcomeName, screenId) {
            currentSession.outcome = outcomeName;
            currentSession.endTime = new Date().toISOString(); 
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            try {
                await addDoc(collection(db, "vaka_kayitlari"), {
                    ...currentSession,
                    createdAt: Timestamp.now()
                });
                console.log("KayÄ±t Firebase'e gÃ¶nderildi.");
            } catch (error) {
                console.error("Firebase HatasÄ±:", error);
            }
        }

        window.resetCase = function() {
            currentSession = {
                id: 'user_' + Math.random().toString(36).substr(2, 9),
                startTime: new Date().toISOString(),
                path: [],
                outcome: ''
            };
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scene1').classList.add('active');
        };

        // --- Data & Admin Functions ---

        window.toggleAdmin = function() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) loadAdminData();
        };

        async function loadAdminData() {
            const tbody = document.getElementById('dataTableBody');
            const loadingMsg = document.getElementById('loadingMsg');
            
            tbody.innerHTML = '';
            loadingMsg.style.display = 'block';

            try {
                const q = query(collection(db, "vaka_kayitlari"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                loadingMsg.style.display = 'none';

                querySnapshot.forEach((doc) => {
                    const session = doc.data();
                    const row = document.createElement('tr');
                    
                    let dateStr = "Belirsiz";
                    if(session.createdAt && session.createdAt.toDate) {
                        dateStr = session.createdAt.toDate().toLocaleString('tr-TR');
                    } else if (session.startTime) {
                        dateStr = new Date(session.startTime).toLocaleString('tr-TR');
                    }
                    
                    let color = 'black';
                    if(session.outcome.includes('MÃ¼kemmel') || session.outcome.includes('BaÅŸarÄ±lÄ±')) color = 'green';
                    else if(session.outcome.includes('KBY') || session.outcome.includes('HasarlÄ±')) color = 'orange';
                    else color = 'red';

                    row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${session.id}</td>
                        <td class="path-visual">${session.path.join(' â ')}</td>
                        <td style="color:${color}; font-weight:bold;">${session.outcome}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                loadingMsg.innerText = "Veri Ã§ekilemedi: " + error.message;
                console.error(error);
            }
        }

        window.exportCSV = async function() {
            try {
                const q = query(collection(db, "vaka_kayitlari"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) return alert('Veri yok');

                let csv = "ID,Tarih,Yol,Sonuc\n";
                querySnapshot.forEach((doc) => {
                    const h = doc.data();
                    const dateStr = h.startTime || "N/A";
                    const pathStr = `"${h.path.join('->')}"`;
                    csv += `${h.id},${dateStr},${pathStr},"${h.outcome}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ahus_pediatrik_vaka_verileri.csv';
                a.click();
            } catch (e) {
                console.error(e);
                alert("CSV oluÅŸturulurken hata oluÅŸtu.");
            }
        }
    </script>
</body>
</html>

